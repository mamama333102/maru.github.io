<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã¾ã‚‹ã¡ã‚ƒã‚“ãƒã‚¦ã‚¹</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        :root { --wall-color: #fce4ec; --floor-color: #f06292; }
        body { margin: 0; font-family: sans-serif; overflow: hidden; background: #333; touch-action: manipulation; }
        #game-screen { width: 100vw; height: 100vh; display: flex; flex-direction: column; }
        #room { flex-grow: 1; position: relative; background: linear-gradient(var(--wall-color) 50%, var(--floor-color) 50%); overflow: hidden; }
        .pet { position: absolute; width: 100px; height: 100px; cursor: pointer; z-index: 10; transition: left 3s linear, top 3s linear;}
/* CSSã® .pet img éƒ¨åˆ†ã‚’ä¿®æ­£ */
.pet img {
    width: 100%;
    height: 100%;
    position: absolute;
    top: 0;
    left: 0;
    pointer-events: none;
    /* transitionã‚’ã“ã“ã‹ã‚‰å‰Šé™¤ã€ã¾ãŸã¯transformã‚’é™¤å¤–ã™ã‚‹ */
    transition: transform 0s; /* åè»¢(transform)ã ã‘ã¯ä¸€ç¬ã§åæ˜ ã•ã›ã‚‹ */
}

/* åè»¢ç”¨ã®ã‚¯ãƒ©ã‚¹ã‚’ã‚ˆã‚Šç¢ºå®Ÿã«å®šç¾© */
.flip-img {
    transform: scaleX(-1);
}
        #ui-layer { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; z-index: 50; width: 95%; max-width: 500px; }
        button { padding: 12px 5px; cursor: pointer; border-radius: 12px; border: none; background: white; box-shadow: 0 4px 0 #bbb; font-weight: bold; font-size: 11px; }
        button:active { transform: translateY(2px); box-shadow: none; }
        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 20px; z-index: 100; box-shadow: 0 0 30px rgba(0,0,0,0.3); width: 85%; max-width: 350px; text-align: center; max-height: 85vh; overflow-y: auto; }
        .modal-open { display: block !important; }
        .preview-box { position: relative; width: 100px; height: 100px; margin: 10px auto; background: #eee; border-radius: 50%; border: 2px solid #ccc; overflow: hidden; }
        .preview-box img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #qrcode-output { margin-top: 10px; display: flex; justify-content: center; min-height: 120px; background: #f9f9f9; align-items: center; }
        .list-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #eee; padding: 5px; }
    </style>
</head>
<body>

<div id="game-screen">
    <div id="room" onclick="if(event.target === this) closeAllModals()"></div>
    <div id="ui-layer">
        <button onclick="openBox()">ãƒœãƒƒã‚¯ã‚¹</button>
        <button onclick="openCreateMenu()">ãƒ‡ã‚¶ã‚¤ãƒ³</button>
        <button onclick="openModal('scan-modal')">è³¼å…¥(QR)</button>
        <button onclick="openGachaMenu('parts')">ãƒ‘ãƒ¼ãƒ„ã‚¬ãƒãƒ£</button>
        <button onclick="openGachaMenu('acc')">ã‚¢ã‚¯ã‚»ã‚¬ãƒãƒ£</button>
        <button onclick="openShop()">ã‚·ãƒ§ãƒƒãƒ—</button>
        <button onclick="changeRoomColor()">éƒ¨å±‹è¨­å®š</button>
    </div>
</div>

<div id="detail-modal" class="modal">
    <h2 id="det-name"></h2>
    <p>æº€è…¹åº¦: <span id="det-hunger"></span>% / ã‚­ãƒ¢ãƒ: <span id="det-feeling"></span></p>
    <div id="det-tags" style="color:#666; font-size:0.8em;"></div>
    <hr>
    <button onclick="openFeedSelect()">é¤Œã‚„ã‚Š</button>
    <button onclick="openEquipMenu()">ããŒãˆ</button>
    <button onclick="sendFeeling()">ã‚­ãƒ¢ãƒé€ä¿¡</button>
    <button onclick="closeAllModals()">ã¨ã˜ã‚‹</button>
</div>

<div id="gacha-modal" class="modal">
    <h3 id="gacha-title">ã‚¬ãƒãƒ£</h3>
    <p>æ‰€æŒ: <span id="money-display"></span>æš / ãƒ€ãƒ–ãƒª: <span id="dust-display"></span>pt</p>
    <div id="gacha-result-area" style="font-weight:bold; color:#f06292; margin:10px 0; min-height:1.2em;"></div>
    <button id="gacha-exec-btn">ã‚¬ãƒãƒ£ã‚’å›ã™ (100æš)</button>
    <button onclick="closeAllModals()">æˆ»ã‚‹</button>
</div>

<div id="shop-modal" class="modal">
    <h3>ã‚¨ã‚µã‚·ãƒ§ãƒƒãƒ—</h3>
    <p>æ‰€æŒé‡‘: <span id="shop-money"></span>æš</p>
    <div id="shop-list"></div>
    <button onclick="closeAllModals()">é–‰ã˜ã‚‹</button>
</div>

<div id="feed-select-modal" class="modal">
    <h3>ã©ã‚Œã‚’ã‚ã’ã‚‹ï¼Ÿ</h3>
    <div id="food-inventory-list"></div>
    <button onclick="openModal('detail-modal')">æˆ»ã‚‹</button>
</div>

<div id="equip-modal" class="modal">
    <h3>ã‚¢ã‚¯ã‚»ã‚µãƒªè£…å‚™</h3>
    <div id="equip-list"></div>
    <button onclick="openModal('detail-modal')">æˆ»ã‚‹</button>
</div>

<div id="create-modal" class="modal">
    <h3>ã¾ã‚‹ã¡ã‚ƒã‚“ç”Ÿæˆ</h3>
    <div class="preview-box">
        <img id="p-body-img" src="">
        <img id="p-eye-img" src="">
        <img id="p-mouth-img" src="">
    </div>
    <input type="text" id="c-name" placeholder="ãªã¾ãˆ" maxlength="8"><br>
    ä½“è‰²: <select id="c-sel-body" onchange="updatePreview()"></select><br>
    ç›®: <select id="c-sel-eye" onchange="updatePreview()"></select><br>
    å£: <select id="c-sel-mouth" onchange="updatePreview()"></select><br>
    ã‚¿ã‚°1: <input type="text" id="c-t1" placeholder="ã’ã‚“ã" size="6">
    ã‚¿ã‚°2: <input type="text" id="c-t2" placeholder="ãã„ã—ã‚“ã¼ã†" size="6"><br>
    é›£åº¦: <select id="c-diff"><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
    å¥½ç‰©: <select id="c-fav"><option value="é«˜ç´šã‚¹ãƒ†ãƒ¼ã‚­">é«˜ç´šã‚¹ãƒ†ãƒ¼ã‚­</option><option value="ãƒ‘ãƒ³">ãƒ‘ãƒ³</option></select><br>
    <hr>
    <button onclick="generateQR()">QRç™ºè¡Œ(è²©å£²)</button>
    <div id="qrcode-output"></div>
    <button onclick="closeAllModals()">é–‰ã˜ã‚‹</button>
</div>

<div id="box-modal" class="modal">
    <h3>ãƒœãƒƒã‚¯ã‚¹ (éƒ¨å±‹ã¯3åŒ¹ã¾ã§)</h3>
    <div id="box-list"></div>
    <button onclick="closeAllModals()">é–‰ã˜ã‚‹</button>
</div>

<div id="scan-modal" class="modal">
    <h3>QRã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Š</h3>
    <input type="file" accept="image/*" onchange="scanFile(this)">
    
    <div id="buy-area" style="display:none; border:2px dashed #ff99aa; padding:15px; border-radius:15px; background:#fff5f7; margin-top:15px;">
    <h3 style="margin:0 0 10px 0; color:#d63384;">ã‚ãŸã‚‰ã—ã„ ã¾ã‚‹ã¡ã‚ƒã‚“ï¼</h3>
    
    <div id="buy-preview" style="width:120px; height:120px; margin: 0 auto 10px; position: relative; background:#fff; border-radius:50%; border:2px solid #ffccd5; overflow:hidden;">
        </div>

    <div id="buy-info" style="font-weight:bold; margin-bottom:10px; color:#555;"></div>
    
    <div style="display:flex; gap:10px;">
        <button id="buy-btn" style="flex:1; background:#ff4785; color:white; border:none; padding:10px; border-radius:8px; cursor:pointer; font-weight:bold;">è³¼å…¥ã™ã‚‹</button>
        <button onclick="document.getElementById('buy-area').style.display='none'" style="flex:1; background:#ccc; border:none; padding:10px; border-radius:8px; cursor:pointer;">ã‚„ã‚ã‚‹</button>
    </div>
</div>
    
    <button onclick="closeAllModals()" style="margin-top:10px;">æˆ»ã‚‹</button>
</div>

<script>
/** --- ãƒ‡ãƒ¼ã‚¿å®šç¾© --- **/
const MASTER_DATA = {
    bodies: [
        {id:'b1', name:'ç™½ã¾ã‚‹', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/syoki_b.png'}, // ã“ã“ã‚’ãƒ•ã‚¡ã‚¤ãƒ«åã«
        {id:'b2', name:'æ¡ƒã¾ã‚‹', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/pink_b.png'},
        {id:'b3', name:'é»’ã¾ã‚‹', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/black_b.png'},
        {id:'b4', name:'é’ã¾ã‚‹', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/bule_b.png'},
{id:'b5', name:'ç·‘ã¾ã‚‹', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/green_b.png'},
{id:'b6', name:'ç´«ã¾ã‚‹', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/purple_b.png'},
{id:'b7', name:'èµ¤ã¾ã‚‹', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/red_b.png'},
{id:'b8', name:'ã‚ªãƒ¬ãƒ³ã‚¸ã¾ã‚‹', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/b1.png'},
{id:'b9', name:'ã¿ãƒ¼ã¾ã‚‹', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/b2.png'},
{id:'b10', name:'é»„ã¾ã‚‹', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/b3.png'},
{id:'b11', name:'ã²ã®ã¾ã‚‹', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/b4.png'}
],
    eyes: [
        {id:'e1', name:'ãµã¤ã†ã®ç›®', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/syoki_me.png'},
        {id:'e2', name:'ã‚¸ãƒˆç›®', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/zitome.png'},
 {id:'e3', name:'aç›®', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/a_me.png'},
 {id:'e4', name:'é»’ã„ç›®', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/black_me.png'},
 {id:'e5', name:'é’ã„ç›®', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/blue_me.png'},
 {id:'e6', name:'ç·‘ã®ç›®', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/green_me.png'},
 {id:'e7', name:'é€†ã‚¸ãƒˆç›®', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/gyaku_jitome.png'},
 {id:'e8', name:'ã‚«ã‚¤ãƒˆãƒ¼ç›®', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/kaitou.png'},
 {id:'e9', name:'ã¾ã¤æ¯›ã¤ãé–‰ã˜ç›®', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/matuge_tizi.png'},
  {id:'e10', name:'æ€’ã£ãŸç›®', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/okoru.png'},
   {id:'e11', name:'ç´«ã®ç›®', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/purple_me.png'},
 {id:'e12', name:'èµ¤ã„ç›®', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/red_me.png'},
 {id:'e13', name:'çŒ«ç›®', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/riaru_me.png'},
 {id:'e14', name:'tç›®', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/t_me.png'},
 {id:'e15', name:'å˜çœ¼', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/tangan.png'},
 {id:'e16', name:'ç‚¹', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/ten.png'},
 {id:'e17', name:'é–‰ã˜ã‚‹', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/toziru.png'},
  {id:'e18', name:'ã°ã£ã¦ã‚“ç›®', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/e1.png'},
   {id:'e19', name:'å››è§’ã®ç›®', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/e2.png'},
    {id:'e20', name:'ã°ã¤ç›®', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/e3.png'}
],
    mouths: [
        {id:'m1', name:'ã«ã£ã“ã‚Š', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/syoki_kuti.png'},
 {id:'m2', name:'ã‚¢ãƒ´ã‚¡å£', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/ava_kuti.png'},
 {id:'m3', name:'å¤§ããªå››è§’', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/big_sikaku_kuti.png'},
 {id:'m4', name:'æ­¯ã‚’è¦‹ã›ã‚‹', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/ha_kuti.png'},
 {id:'m5', name:'å°ã•ãª', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/kuti_2.png'},
  {id:'m6', name:'ä¸­ãã‚‰ã„ã®', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/kuti_3.png'},
 {id:'m7', name:'nå£', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/n_kuti.png'},
 {id:'m8', name:'ã‚µã‚¶ã‚¨å£', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/sazae.png'},
 {id:'m9', name:'å››è§’', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/sikaku_kuti.png'},
 {id:'m10', name:'uå£', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/u_kuti.png'},
 {id:'m11', name:'wå£é–‹ã', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/w_hiraku.png'},
 {id:'m12', name:'wå£', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/w_kuti.png'},
 {id:'m13', name:'å…«é‡æ­¯é–‰ã˜ã‚‹', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/yaeba.png'},
 {id:'m14', name:'må£', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/m1.png'},
 {id:'m15', name:'é³¥ã®å£', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/m2.png'},
 {id:'m16', name:'3å£', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/m3.png'},
 {id:'m17', name:'ã‚®ã‚¶ã‚®ã‚¶', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/m4.png'},
  {id:'m18', name:'ãƒ•ãƒ ãƒ•ãƒ ', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/m5.png'},
   {id:'m19', name:'ã‚¿ã‚³ã‚¿ã‚³', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/m6.png'}
],
    accessories: [
        {id:'a1', name:'é»’ãƒªãƒœãƒ³', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/black_ri.png'},
        {id:'a2', name:'é’ã„ãƒãƒ³ãƒ€ãƒŠ', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/blue_ban.png'},
        {id:'a3', name:'é’ãƒªãƒœãƒ³', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/blue_ri.png'},
        {id:'a4', name:'sfã‚´ãƒ¼ã‚°ãƒ«', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/goggles.png'},
        {id:'a5', name:'ã‚°ãƒ¬ãƒ¼ãƒªãƒœãƒ³', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/grade_r.png'},
        {id:'a6', name:'ç·‘ãƒªãƒœãƒ³', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/green_ri.png'},
        {id:'a7', name:'è‘‰ã£ã±', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/happa.png'},
        {id:'a8', name:'ã²ã¾ã‚ã‚Š', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/himawari.png'},
        {id:'a9', name:'æ­´æˆ¦ã®å‚·', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/kizu.png'},
        {id:'a10', name:'ã‚³ã‚±', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/koke.png'},
        {id:'a11', name:'ãŸã‚Œè€³', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/mimi.png'},
        {id:'a12', name:'æ¡ƒè‰²ã®ãƒãƒ³ãƒ€ãƒŠ', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/pink_ban.png'},
        {id:'a13', name:'ç´«ãƒªãƒœãƒ³', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/purple_r.png'},
        {id:'a14', name:'èµ¤ã„ãƒãƒ³ãƒ€ãƒŠ', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/red_ban.png'},
        {id:'a15', name:'èµ¤ã„èŠ±', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/red_hana.png'},
        {id:'a16', name:'èµ¤ãƒªãƒœãƒ³', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/red_ri.png'},
        {id:'a17', name:'é›ª', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/snow.png'},
        {id:'a18', name:'é»„è‰²ã„ãƒãƒ³ãƒ€ãƒŠ', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/yellow_ban.png'},
        {id:'a19', name:'é»„ãƒªãƒœãƒ³', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/yellow_ri.png'},
        {id:'a20', name:'ã‚¢ãƒ´ã‚¡ã‚¢ã‚¯ã‚»', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/a1.png'},
        {id:'a21', name:'ç‹å† ', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/a2.png'},
        {id:'a22', name:'æ‚ªé­”ã®ãƒ„ãƒ', img:'https://raw.githubusercontent.com/mamama333102/maru_deta_item/main/a3.png'}
        
    ]
};

const FOOD_DATA = [
    { id: 'f1', name: 'ãƒªãƒ³ã‚´', price: 15, recovery: 20 },
    { id: 'f2', name: 'é«˜ç´šã‚¹ãƒ†ãƒ¼ã‚­', price: 30, recovery: 80 },
    { id: 'f3', name: 'ã¾ã‚‹ãƒ‘ãƒ³', price: 15, recovery: 30 }
];

const ALL_PARTS = [...MASTER_DATA.bodies, ...MASTER_DATA.eyes, ...MASTER_DATA.mouths];
const ALL_ACCESSORIES = MASTER_DATA.accessories;

let userData = {
    money: 1000, dustPoints: 0, lastLogin: 0, lastSaveTime: Date.now(),
    inventory: { 
        bodies:['b1'], eyes:['e1'], mouths:['m1'], 
        accessories:['a1'], 
        foods: { 'f1': 3 } 
    },
    roomPets: [], boxPets: [],
    roomConfig: { wall: '#fce4ec', floor: '#f06292' }
};

let selectedPetId = null;

/** --- åŸºæœ¬æ©Ÿèƒ½ --- **/
function openModal(id) {
    closeAllModals();
    document.getElementById(id).classList.add('modal-open');
}
function closeAllModals() {
    document.querySelectorAll('.modal').forEach(m => m.classList.remove('modal-open'));
}

function save() {
    const now = Date.now();
    const lastSave = userData.lastSaveTime || now;
    const secondsPassed = Math.floor((now - lastSave) / 1000);
    
    // 60ç§’ï¼ˆ1åˆ†ï¼‰ä»¥ä¸ŠçµŒéã—ã¦ã„ãŸã‚‰è¨ˆç®—ã‚’å®Ÿè¡Œ
    if (secondsPassed >= 60) {
        const mins = Math.floor(secondsPassed / 60);
        calculateProgress(mins);
        // è¨ˆç®—ã—ãŸåˆ†ã ã‘åŸºæº–æ™‚é–“ã‚’æ›´æ–°
        userData.lastSaveTime += mins * 60000;

        // å¸¸ã«æœ€æ–°ã®çŠ¶æ…‹ã‚’ä¿å­˜
    localStorage.setItem('maru_v3_ext', JSON.stringify(userData));
    
    // ç”»é¢ä¸Šã®æ‰€æŒé‡‘è¡¨ç¤º(money-display)ã‚’æœ€æ–°ã«ã™ã‚‹
    const moneyEl = document.getElementById('money-display');
    if (moneyEl) moneyEl.innerText = userData.money;
}
}

function load() {
    const d = localStorage.getItem('maru_v3_ext');
    if(d) {
        userData = JSON.parse(d);
        // ãƒ‡ãƒ¼ã‚¿è£œå®Œï¼ˆè¿½åŠ æ©Ÿèƒ½ç”¨ï¼‰
        if(!userData.inventory.foods) userData.inventory.foods = { 'f1': 3 };
        if(!userData.inventory.accessories) userData.inventory.accessories = ['a1'];
        
        document.documentElement.style.setProperty('--wall-color', userData.roomConfig.wall);
        document.documentElement.style.setProperty('--floor-color', userData.roomConfig.floor);
        checkLoginBonus();
        applyOfflineTime();
    }
}

function checkLoginBonus() {
    const today = new Date().toLocaleDateString();
    if(userData.lastLogin !== today) {
        userData.money += 600;
        userData.lastLogin = today;
        alert("ãƒ­ã‚°ã‚¤ãƒ³ãƒœãƒ¼ãƒŠã‚¹ï¼600ã‚³ã‚¤ãƒ³ç²å¾—ï¼");
        save();
        saveToLocalStorage(); // æœ€çµ‚çš„ã«ä¿å­˜
    }
}

function applyOfflineTime() {
    const now = Date.now();
    const lastSave = userData.lastSaveTime || now;
    const diffMin = Math.floor((now - lastSave) / 60000);
    
    if (diffMin > 0) {
        calculateProgress(diffMin);
        userData.lastSaveTime = now; // æ”¾ç½®åˆ†ã‚’åæ˜ å®Œäº†
        save();
    }
}

/** --- ã‚¬ãƒãƒ£æ©Ÿèƒ½ --- **/
function openGachaMenu(type) {
    document.getElementById('money-display').innerText = userData.money;
    document.getElementById('dust-display').innerText = userData.dustPoints;
    document.getElementById('gacha-result-area').innerText = "";
    
    const title = document.getElementById('gacha-title');
    const btn = document.getElementById('gacha-exec-btn');

    if(type === 'parts') {
        title.innerText = "ãƒ‘ãƒ¼ãƒ„ã‚¬ãƒãƒ£ (100æš)";
        btn.onclick = () => playGacha('parts');
    } else {
        title.innerText = "ã‚¢ã‚¯ã‚»ã‚¬ãƒãƒ£ (100æš)";
        btn.onclick = () => playGacha('acc');
    }
    openModal('gacha-modal');
}

function playGacha(type) {
    if(userData.money < 100) return alert("ã‚³ã‚¤ãƒ³ä¸è¶³");
    userData.money -= 100;
    
    const pool = (type === 'parts') ? ALL_PARTS : ALL_ACCESSORIES;
    const res = pool[Math.floor(Math.random() * pool.length)];
    let isNew = false;

    if(type === 'parts') {
        const typeKey = res.id.startsWith('b') ? 'bodies' : res.id.startsWith('e') ? 'eyes' : 'mouths';
        if(!userData.inventory[typeKey].includes(res.id)) {
            userData.inventory[typeKey].push(res.id);
            isNew = true;
        }
    } else {
        if(!userData.inventory.accessories.includes(res.id)) {
            userData.inventory.accessories.push(res.id);
            isNew = true;
        }
    }

    if(!isNew) {
        userData.dustPoints++;
        if(userData.dustPoints >= 5) {
            userData.dustPoints -= 5;
            document.getElementById('gacha-result-area').innerText = "ãƒ€ãƒ–ãƒª5å›ã§å†æŠ½é¸ï¼";
            return playGacha(type);
        }
    }

    document.getElementById('gacha-result-area').innerText = (isNew ? "âœ¨NEWâœ¨ " : "ï¼ˆãƒ€ãƒ–ãƒªï¼‰") + res.name;
    document.getElementById('money-display').innerText = userData.money;
    document.getElementById('dust-display').innerText = userData.dustPoints;
    save();
    saveToLocalStorage(); // æœ€çµ‚çš„ã«ä¿å­˜
}

/** --- ã‚·ãƒ§ãƒƒãƒ—æ©Ÿèƒ½ --- **/
function openShop() {
    document.getElementById('shop-money').innerText = userData.money;
    const list = document.getElementById('shop-list');
    list.innerHTML = FOOD_DATA.map(f => `
        <div class="list-item">
            <span>${f.name} (${f.price}æš)</span>
            <button onclick="buyFood('${f.id}')">è³¼å…¥</button>
        </div>
    `).join('');
    openModal('shop-modal');
}

function buyFood(id) {
    const food = FOOD_DATA.find(f => f.id === id);
    if(userData.money < food.price) return alert("ã‚³ã‚¤ãƒ³ä¸è¶³");
    userData.money -= food.price;
    userData.inventory.foods[id] = (userData.inventory.foods[id] || 0) + 1;
    document.getElementById('shop-money').innerText = userData.money;
    save();
    saveToLocalStorage(); // æœ€çµ‚çš„ã«ä¿å­˜
}

/** --- ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®š --- **/
function openCreateMenu() {
    const fillSelect = (id, key) => {
        const sel = document.getElementById(id);
        sel.innerHTML = userData.inventory[key].map(itemId => {
            const item = ALL_PARTS.find(x => x.id === itemId);
            return `<option value="${item.id}">${item.name}</option>`;
        }).join('');
    };
    fillSelect('c-sel-body', 'bodies');
    fillSelect('c-sel-eye', 'eyes');
    fillSelect('c-sel-mouth', 'mouths');
    updatePreview();
    openModal('create-modal');
}
function updatePreview() {
    const getImg = (selId) => {
        const val = document.getElementById(selId).value;
        const found = ALL_PARTS.find(x => x.id === val);
        return found ? found.img : "";
    };
    document.getElementById('p-body-img').src = getImg('c-sel-body');
    document.getElementById('p-eye-img').src = getImg('c-sel-eye');
    document.getElementById('p-mouth-img').src = getImg('c-sel-mouth');
}

function changeRoomColor() {
    const wall = prompt("å£ã®è‰²(ä¾‹: #fce4ec)", userData.roomConfig.wall);
    const floor = prompt("åºŠã®è‰²(ä¾‹: #f06292)", userData.roomConfig.floor);
    if(wall) userData.roomConfig.wall = wall;
    if(floor) userData.roomConfig.floor = floor;
    document.documentElement.style.setProperty('--wall-color', userData.roomConfig.wall);
    document.documentElement.style.setProperty('--floor-color', userData.roomConfig.floor);
    save();
    saveToLocalStorage();
}

/** --- éƒ¨å±‹ã®æç”»ã¨ç§»å‹• --- **/
function refreshRoom() {
    const room = document.getElementById('room');
    room.innerHTML = '';
    userData.roomPets.forEach(p => {
        const div = document.createElement('div');
        div.className = 'pet';
        
        let html = `
            <img src="${ALL_PARTS.find(x=>x.id===p.bodyId).img}">
            <img src="${ALL_PARTS.find(x=>x.id===p.eyeId).img}">
            <img src="${ALL_PARTS.find(x=>x.id===p.mouthId).img}">
        `;

        if(p.equippedAcc) {
            p.equippedAcc.forEach(accId => {
                const acc = MASTER_DATA.accessories.find(a => a.id === accId);
                if(acc) html += `<img src="${acc.img}">`;
            });
        }

        div.innerHTML = html;
        div.onclick = (e) => { e.stopPropagation(); openDetail(p); };
        room.appendChild(div);
        animatePet(div);
    });
}
function animatePet(el) {
    const walk = () => {
        if (!el.parentElement) return;

        // æ¬¡ã®ç§»å‹•å…ˆã‚’è¨ˆç®—
        const nextX = Math.random() * (window.innerWidth - 100);
        const nextY = window.innerHeight * 0.6 + Math.random() * (window.innerHeight * 0.2);
        
        // ç¾åœ¨ã®åº§æ¨™ã‚’å–å¾—
        const currentX = parseFloat(el.style.left) || 0;
        
        // --- å‘ãã®åè»¢å‡¦ç†ï¼ˆã“ã“ã‚’æ”¹å–„ï¼‰ ---
        // æ¬¡ã®åœ°ç‚¹ãŒä»Šã®å ´æ‰€ã‚ˆã‚Šå³ãªã‚‰å³å‘ãã€å·¦ãªã‚‰å·¦å‘ã
        const imgs = el.querySelectorAll('img');
        if (nextX > currentX) {
            // å³ã«å‹•ãã¨ãã¯åè»¢ã‚’è§£é™¤
            imgs.forEach(img => img.classList.add('flip-img'));
        } else {
            // å·¦ã«å‹•ãã¨ãã¯å³åº§ã«åè»¢
            imgs.forEach(img => img.classList.remove('flip-img'));
        }

        // ç§»å‹•é€Ÿåº¦ï¼ˆè·é›¢ã«å¿œã˜ã¦æ™‚é–“ã‚’å¤‰ãˆã‚‹ã¨ã‚ˆã‚Šè‡ªç„¶ã§ã™ï¼‰
        const dur = 3000 + Math.random() * 3000;

        // ç§»å‹•ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
        el.style.transition = `left ${dur/1000}s linear, top ${dur/1000}s linear`;
        el.style.left = nextX + 'px';
        el.style.top = nextY + 'px';

        // æ¬¡ã®ç§»å‹•ã¾ã§ã®å¾…æ©Ÿæ™‚é–“ï¼ˆç§»å‹•æ™‚é–“ + ä¼‘æ†©ï¼‰
        setTimeout(walk, dur + 1000);
    };

    // åˆå›å®Ÿè¡Œæ™‚ã«å°‘ã—é…ã‚‰ã›ã¦é–‹å§‹
    setTimeout(walk, Math.random() * 1000);
}

function openDetail(pet) {
    selectedPetId = pet.id;
    document.getElementById('det-name').innerText = pet.name;
    document.getElementById('det-hunger').innerText = pet.hunger;
    document.getElementById('det-feeling').innerText = pet.feeling;
    document.getElementById('det-tags').innerText = pet.tags.join(" ");
    openModal('detail-modal');
}

/** --- ãƒœãƒƒã‚¯ã‚¹æ©Ÿèƒ½ (æ”¹åæ©Ÿèƒ½ä»˜ã) --- **/
function openBox() {
    const list = document.getElementById('box-list');
    list.innerHTML = '';
    
    // éƒ¨å±‹ã«ã„ã‚‹ãƒšãƒƒãƒˆã¨ãƒœãƒƒã‚¯ã‚¹ã«ã„ã‚‹ãƒšãƒƒãƒˆã‚’çµ±åˆ
    const all = [
        ...userData.roomPets.map(p => ({...p, loc:'room'})), 
        ...userData.boxPets.map(p => ({...p, loc:'box'}))
    ];
    
    all.forEach(p => {
        const item = document.createElement('div');
        item.className = 'list-item';
        item.style = "display: flex; align-items: center; gap: 10px; margin-bottom: 8px;";
        
        // åå‰å…¥åŠ›æ¬„ï¼ˆinputï¼‰ã®ä½œæˆ
        item.innerHTML = `
            <input type="text" value="${p.name}" 
                style="flex: 1; padding: 5px; border: 1px solid #ccc; border-radius: 4px;"
                onchange="updatePetName(${p.id}, this.value)"
                placeholder="ãªã¾ãˆã‚’å…¥åŠ›">
            <span style="font-size: 0.8em; color: #888;">${p.loc==='room'?'(éƒ¨å±‹)':'(ç®±)'}</span>
        `;
        
        const btn = document.createElement('button');
        btn.innerText = p.loc === 'room' ? 'æˆ»ã™' : 'å‡ºã™';
        btn.style = "padding: 5px 10px;";
        btn.onclick = () => togglePetLoc(p.id, p.loc);
        
        item.appendChild(btn);
        list.appendChild(item);
    });
    openModal('box-modal');
}
function togglePetLoc(id, current) {
    if(current === 'box') {
        if(userData.roomPets.length >= 3) return alert("éƒ¨å±‹ã¯3åŒ¹ã¾ã§ã§ã™");
        const idx = userData.boxPets.findIndex(p => p.id === id);
        userData.roomPets.push(userData.boxPets.splice(idx, 1)[0]);
    } else {
        const idx = userData.roomPets.findIndex(p => p.id === id);
        userData.boxPets.push(userData.roomPets.splice(idx, 1)[0]);
    }
    save(); refreshRoom(); openBox();
}

/** --- è‚²æˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³ --- **/
function openFeedSelect() {
    const list = document.getElementById('food-inventory-list');
    list.innerHTML = '';
    let hasFood = false;
    for(let id in userData.inventory.foods) {
        if(userData.inventory.foods[id] > 0) {
            hasFood = true;
            const food = FOOD_DATA.find(f => f.id === id);
            const btn = document.createElement('button');
            btn.style = "width:100%; margin-bottom:5px; padding:10px;";
            btn.innerText = `${food.name} (æ®‹ã‚Š${userData.inventory.foods[id]}å€‹)`;
            btn.onclick = () => doFeed(id);
            list.appendChild(btn);
        }
    }
    if(!hasFood) list.innerHTML = "<p>ã‚¨ã‚µã‚’æŒã£ã¦ã„ã¾ã›ã‚“ã€‚ã‚·ãƒ§ãƒƒãƒ—ã§è²·ã£ã¦ã­ï¼</p>";
    openModal('feed-select-modal');
}

/** --- ã‚¨ã‚µã‚„ã‚Šï¼ˆå³æ™‚ä¿å­˜ä»˜ãï¼‰ --- **/
function doFeed(foodId) {
    const p = userData.roomPets.find(x => x.id === selectedPetId);
    const food = FOOD_DATA.find(f => f.id === foodId);
    
    if (!p) return;
    if (p.hunger >= 100) {
        alert("ãŠè…¹ã„ã£ã±ã„ã§ã™ï¼");
        return;
    }
    
    // 1. æº€è…¹åº¦ã‚’ã‚¢ãƒƒãƒ—
    p.hunger = Math.min(100, (p.hunger || 0) + food.recovery);
    
    // 2. åœ¨åº«ã‚’æ¸›ã‚‰ã™
    userData.inventory.foods[foodId]--;
    
    // 3. ã€é‡è¦ã€‘å³åº§ã«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¸ä¿å­˜
    userData.lastSaveTime = Date.now(); // ä¿å­˜æ™‚åˆ»ã‚‚æ›´æ–°
    localStorage.setItem('maru_v3_ext', JSON.stringify(userData));
    
    console.log(`${food.name}ã‚’ã‚ã’ã¾ã—ãŸã€‚ç¾åœ¨ã®æº€è…¹åº¦: ${p.hunger}`);

    // 4. è¡¨ç¤ºã®æ›´æ–°
    openDetail(p);      // è©³ç´°ç”»é¢ã®æ•°å€¤ã‚’æ›´æ–°
    openFeedSelect();   // ã‚¨ã‚µé¸æŠãƒªã‚¹ãƒˆã®æ®‹ã‚Šå€‹æ•°ã‚’æ›´æ–°
}

function openEquipMenu() {
    const p = userData.roomPets.find(x => x.id === selectedPetId);
    if(!p.equippedAcc) p.equippedAcc = [];
    
    const list = document.getElementById('equip-list');
    list.innerHTML = userData.inventory.accessories.map(accId => {
        const acc = MASTER_DATA.accessories.find(a => a.id === accId);
        const isEquipped = p.equippedAcc.includes(accId);
        return `
            <div class="list-item">
                <span>${acc.name}</span>
                <button onclick="toggleEquip('${accId}')">${isEquipped ? 'ã¯ãšã™' : 'ã¤ã‘ã‚‹'}</button>
            </div>
        `;
    }).join('');
    openModal('equip-modal');
}

/** --- ã‚¢ã‚¯ã‚»ã‚µãƒªç€è„±ï¼ˆå³æ™‚ä¿å­˜ä»˜ãï¼‰ --- **/
function toggleEquip(accId) {
    // é¸æŠä¸­ã®ãƒšãƒƒãƒˆã‚’ç‰¹å®š
    const p = userData.roomPets.find(x => x.id === selectedPetId);
    if (!p) return;
    
    // é…åˆ—ãŒå£Šã‚Œã¦ã„ãŸã‚‰ç›´ã™
    if (!Array.isArray(p.equippedAcc)) p.equippedAcc = [];
    
    const idx = p.equippedAcc.indexOf(accId);
    if (idx > -1) {
        p.equippedAcc.splice(idx, 1); // ã™ã§ã«æŒã£ã¦ã„ã‚Œã°å¤–ã™
    } else {
        p.equippedAcc.push(accId);    // æŒã£ã¦ã„ãªã‘ã‚Œã°ä»˜ã‘ã‚‹
    }

    // --- ã“ã“ã§å¼·åŠ›ã«ä¿å­˜ ---
    userData.lastSaveTime = Date.now();
    localStorage.setItem('maru_v3_ext', JSON.stringify(userData));
    
    // ç”»é¢ã‚’æ›´æ–°
    refreshRoom();
    openEquipMenu(); 
    console.log(`${p.name} ã®ã‚¢ã‚¯ã‚»ã‚µãƒªã‚’ä¿å­˜ã—ã¾ã—ãŸ:`, p.equippedAcc);
}

/** --- ç§»å‹•ç¯„å›²ã®èª¿æ•´ï¼ˆåœ°é¢ã®æ¯”ç‡ã«åˆã‚ã›ã‚‹ï¼‰ --- **/
function animatePet(el) {
    const walk = () => {
        if (!el.parentElement) return;

        const currentX = parseFloat(el.style.left) || 0;
        const nextX = Math.random() * (window.innerWidth - 100);
        
const groundTop = window.innerHeight * 0.6;
        const groundBottom = window.innerHeight * 0.85;
        const nextY = groundTop + Math.random() * (groundBottom - groundTop);
        
        const imgs = el.querySelectorAll('img');
        if (nextX > currentX) {
            imgs.forEach(img => img.classList.add('flip-img'));
        } else {
            imgs.forEach(img => img.classList.remove('flip-img'));
        }

        const dur = 3000 + Math.random() * 3000;
        el.style.transition = `left ${dur/1000}s linear, top ${dur/1000}s linear`;
        el.style.left = nextX + 'px';
        el.style.top = nextY + 'px';

        setTimeout(walk, dur + 1000);
    };
    setTimeout(walk, Math.random() * 1000);
}

/** --- refreshRoom ã®è£œå¼·ï¼ˆã‚¢ã‚¯ã‚»ã‚µãƒªæç”»ï¼‰ --- **/
function refreshRoom() {
    const room = document.getElementById('room');
    room.innerHTML = ''; 
    // æ‰€æŒé‡‘è¡¨ç¤ºã‚’å†é…ç½®ï¼ˆã‚‚ã—æ¶ˆãˆãŸå ´åˆç”¨ï¼‰
    const moneyDisplay = `<div id="money-info" style="position:fixed; top:10px; right:10px; background:white; padding:5px 15px; border-radius:20px; border:2px solid #ff99aa; font-weight:bold; z-index:1000;">ğŸ’° <span id="money-display">${userData.money}</span></div>`;
    room.insertAdjacentHTML('beforeend', moneyDisplay);

    userData.roomPets.forEach(p => {
        const div = document.createElement('div');
        div.className = 'pet';
        // åˆå›é…ç½®ã‚’åœ°é¢ã®ä¸Šã«è¨­å®š
        div.style.left = (Math.random() * 80) + '%';
        div.style.top = (65 + Math.random() * 20) + '%';

        const body = MASTER_DATA.bodies.find(b => b.id === p.bodyId);
        const eye = MASTER_DATA.eyes.find(e => e.id === p.eyeId);
        const mouth = MASTER_DATA.mouths.find(m => m.id === p.mouthId);

        let html = `
            <img src="${body ? body.img : ''}">
            <img src="${eye ? eye.img : ''}">
            <img src="${mouth ? mouth.img : ''}">
        `;

        // ã‚¢ã‚¯ã‚»ã‚µãƒªã‚’ç¢ºå®Ÿã«æç”»
        if (p.equippedAcc) {
            p.equippedAcc.forEach(accId => {
                const acc = MASTER_DATA.accessories.find(a => a.id === accId);
                if (acc) {
                    html += `<img src="${acc.img}">`;
                }
            });
        }

        div.innerHTML = html;
        div.onclick = (e) => { e.stopPropagation(); openDetail(p); };
        room.appendChild(div);
        animatePet(div);
    });
}

/** --- QRã‚³ãƒ¼ãƒ‰é–¢é€£ --- **/
function generateQR() {
    const out = document.getElementById('qrcode-output');
    out.innerHTML = '';
    const data = `M3:${document.getElementById('c-name').value || 'ã¾ã‚‹'},${document.getElementById('c-sel-body').value},${document.getElementById('c-sel-eye').value},${document.getElementById('c-sel-mouth').value},${document.getElementById('c-t1').value},${document.getElementById('c-t2').value},${document.getElementById('c-diff').value},${document.getElementById('c-fav').value}`;
    
    if (typeof QRCode === "undefined") return alert("ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒæº–å‚™ä¸­...");
    new QRCode(out, { text: data, width: 120, height: 120, correctLevel: QRCode.CorrectLevel.M });
}

function scanFile(input) {
    if (!input.files || !input.files[0]) return;
    const reader = new FileReader();
    reader.onload = e => {
        const img = new Image();
        img.onload = () => {
            const cvs = document.createElement('canvas');
            const ctx = cvs.getContext('2d');
            cvs.width = img.width; cvs.height = img.height;
            ctx.drawImage(img, 0, 0);
            const qr = jsQR(ctx.getImageData(0,0,cvs.width,cvs.height).data, cvs.width, cvs.height);
            if(qr && qr.data.startsWith("M3:")) {
                const parts = qr.data.replace("M3:","").split(",");
                const [name, b, e, m, t1, t2, diff, fav] = parts;
                const price = parseInt(diff || 1) * 200;
                
                document.getElementById('buy-area').style.display = 'block';
                document.getElementById('buy-info').innerText = `${name}ã‚’è³¼å…¥(${price}ã‚³ã‚¤ãƒ³)`;
                document.getElementById('buy-btn').onclick = () => {
    const price = petData.diff * 500;

    if (userData.money < price) {
        alert("ã‚³ã‚¤ãƒ³ãŒè¶³ã‚Šã¾ã›ã‚“ï¼");
        return;
    }

    // 1. ãŠé‡‘ã‚’æ¸›ã‚‰ã™
    userData.money -= price;

    // 2. æ–°ã—ã„ãƒšãƒƒãƒˆã‚’ä½œæˆã—ã¦ãƒœãƒƒã‚¯ã‚¹ï¼ˆã¾ãŸã¯éƒ¨å±‹ï¼‰ã«è¿½åŠ 
    const newPet = { 
        id: Date.now(), 
        name: petData.name, 
        bodyId: petData.bodyId, 
        eyeId: petData.eyeId, 
        mouthId: petData.mouthId, 
        tags: [petData.t1, petData.t2], 
        hunger: 100, 
        feeling: 0, 
        equippedAcc: [] 
    };
}
            }
    
    // userDataã®é©åˆ‡ãªå ´æ‰€ã«è¿½åŠ 
    userData.boxPets.push(newPet);

    // 3. ã€é‡è¦ã€‘å³åº§ã«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¸ä¿å­˜
    // ã“ã‚Œã‚’å¿˜ã‚Œã‚‹ã¨ã€ãƒªãƒ­ãƒ¼ãƒ‰ã—ãŸã¨ãã«ãŠé‡‘ã ã‘æ¸›ã£ãŸã‚ŠãƒšãƒƒãƒˆãŒæ¶ˆãˆãŸã‚Šã—ã¾ã™
    saveToLocalStorage(); 

    alert(`${petData.name} ã‚’è¿ãˆã¾ã—ãŸï¼ãƒœãƒƒã‚¯ã‚¹ã‚’ç¢ºèªã—ã¦ã­ã€‚`);
    
    // 4. UIã®æ›´æ–°
    document.getElementById('buy-area').style.display = 'none';
    closeAllModals();
    refreshRoom(); // æ‰€æŒé‡‘è¡¨ç¤ºãªã©ã‚’æ›´æ–°
            }
        }
    };

            /** --- QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆï¼ˆæ¥µé™ã¾ã§çŸ­ç¸®ï¼‰ --- **/
function generateQR() {
    const out = document.getElementById('qrcode-output');
    out.innerHTML = '';
    
    // ãƒ‡ãƒ¼ã‚¿ã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã®æ–‡å­—åˆ—ã«ã¾ã¨ã‚ã‚‹ï¼ˆä½™è¨ˆãªã‚¹ãƒšãƒ¼ã‚¹ã‚’å‰Šé™¤ï¼‰
    const name = document.getElementById('c-name').value || 'ã¾ã‚‹';
    const body = document.getElementById('c-sel-body').value;
    const eye = document.getElementById('c-sel-eye').value;
    const mouth = document.getElementById('c-sel-mouth').value;
    const t1 = document.getElementById('c-t1').value || ' ';
    const t2 = document.getElementById('c-t2').value || ' ';
    const diff = document.getElementById('c-diff').value;
    const fav = document.getElementById('c-fav').value;

    // èª­ã¿å–ã‚ŠãƒŸã‚¹ã‚’æ¸›ã‚‰ã™ãŸã‚ã€è­˜åˆ¥å­ã‚’çŸ­ãã—ã€ãƒ‡ãƒ¼ã‚¿ã®é †ç•ªã‚’å³å®ˆ
    const data = `M3:${name},${body},${eye},${mouth},${t1},${t2},${diff},${fav}`;
    
    if (typeof QRCode === "undefined") return alert("ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­è¾¼ä¸­...");

    try {
        new QRCode(out, {
            text: data,
            width: 150, // å°‘ã—å¤§ããã—ã¦å¯†åº¦ã‚’ä¸‹ã’ã‚‹
            height: 150,
            // æ±šã‚Œã‚„ãƒœã‚±ã«å¼·ã„ã€Œãƒ¬ãƒ™ãƒ«H (High)ã€ã«è¨­å®š
            correctLevel: QRCode.CorrectLevel.H 
        });
    } catch (e) {
        alert("ãƒ‡ãƒ¼ã‚¿ãŒé•·ã™ãã¾ã™ã€‚åå‰ã‚„ã‚¿ã‚°ã‚’çŸ­ãã—ã¦ãã ã•ã„ã€‚");
    }
}

/** --- QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆï¼ˆèª­ã¿å–ã‚Šç‡å‘ä¸Šç‰ˆï¼‰ --- **/
function generateQR() {
    const out = document.getElementById('qrcode-output');
    out.innerHTML = ''; // ã‚¯ãƒªã‚¢
    
    // ãƒ‡ãƒ¼ã‚¿ã‚’åé›†ï¼ˆã‚«ãƒ³ãƒã§ã¯ãªã | ã§åŒºåˆ‡ã‚‹ã“ã¨ã§èª¤ä½œå‹•ã‚’é˜²æ­¢ï¼‰
    const name = document.getElementById('c-name').value || 'ã¾ã‚‹';
    const body = document.getElementById('c-sel-body').value;
    const eye = document.getElementById('c-sel-eye').value;
    const mouth = document.getElementById('c-sel-mouth').value;
    const t1 = document.getElementById('c-t1').value || ' ';
    const t2 = document.getElementById('c-t2').value || ' ';
    const diff = document.getElementById('c-diff').value || '1';
    const fav = document.getElementById('c-fav').value || 'é«˜ç´šã‚¹ãƒ†ãƒ¼ã‚­';

    // è­˜åˆ¥å­ M3: ã‚’å«ã‚ãŸãƒ‡ãƒ¼ã‚¿æ–‡å­—åˆ—
    const data = `M3:${name}|${body}|${eye}|${mouth}|${t1}|${t2}|${diff}|${fav}`;
    
    if (typeof QRCode === "undefined") {
        alert("ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        return;
    }

    try {
        // æ–°ã—ã„QRã‚³ãƒ¼ãƒ‰ã®ä½œæˆ
        new QRCode(out, {
            text: data,
            width: 160,
            height: 160,
            colorDark : "#000000",
            colorLight : "#ffffff",
            correctLevel : QRCode.CorrectLevel.H // ã‚¨ãƒ©ãƒ¼è¨‚æ­£ã‚’æœ€å¤§ã«
        });
    } catch (e) {
        console.error(e);
        alert("QRä½œæˆã‚¨ãƒ©ãƒ¼ã€‚åå‰ã‚„ã‚¿ã‚°ã‚’çŸ­ãã—ã¦ã¿ã¦ãã ã•ã„ã€‚");
    }
}

/** --- QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆï¼ˆèª­ã¿å–ã‚Šã‚„ã™ã•é‡è¦–ï¼‰ --- **/
function generateQR() {
    const out = document.getElementById('qrcode-output');
    out.innerHTML = '';
    
    // ãƒ‡ãƒ¼ã‚¿ã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§æ§‹ç¯‰
    const name = document.getElementById('c-name').value || 'ã¾ã‚‹';
    const b = document.getElementById('c-sel-body').value;
    const e = document.getElementById('c-sel-eye').value;
    const m = document.getElementById('c-sel-mouth').value;
    const t1 = document.getElementById('c-t1').value || ' ';
    const t2 = document.getElementById('c-t2').value || ' ';
    const diff = document.getElementById('c-diff').value;
    const fav = document.getElementById('c-fav').value;

    // ãƒ‡ãƒ¼ã‚¿ãŒå¤šã™ãã‚‹ã¨èª­ã¿å–ã‚Œãªã„ãŸã‚ã€çŸ­ãã¾ã¨ã‚ã‚‹
    const data = `M3:${name},${b},${e},${m},${t1},${t2},${diff},${fav}`;
    
    if (typeof QRCode === "undefined") return alert("ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™...");

    try {
        new QRCode(out, {
            text: data,
            width: 160, // å°‘ã—å¤§ããã™ã‚‹
            height: 160,
            colorDark : "#000000",
            colorLight : "#ffffff",
            correctLevel: QRCode.CorrectLevel.H // å¾©å…ƒãƒ¬ãƒ™ãƒ«æœ€é«˜
        });
    } catch (err) {
        alert("åå‰ã‚„ã‚¿ã‚°ãŒé•·ã™ãã¾ã™ã€‚çŸ­ãã—ã¦ãã ã•ã„ã€‚");
    }
}

/** --- QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ (åˆ¤å®šã‚’ã‚ˆã‚Šç¢ºå®Ÿã«) --- **/
function generateQR() {
    const out = document.getElementById('qrcode-output');
    out.innerHTML = '';
    
    // å…¥åŠ›å€¤ã‚’æ•´ç†
    const name = (document.getElementById('c-name').value || 'ã¾ã‚‹').replace(/,/g, ''); // ã‚«ãƒ³ãƒã‚’ç¦æ­¢
    const b = document.getElementById('c-sel-body').value;
    const e = document.getElementById('c-sel-eye').value;
    const m = document.getElementById('c-sel-mouth').value;
    const t1 = (document.getElementById('c-t1').value || ' ').replace(/,/g, '');
    const t2 = (document.getElementById('c-t2').value || ' ').replace(/,/g, '');
    const diff = document.getElementById('c-diff').value;
    const fav = document.getElementById('c-fav').value;

    // ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
    const data = `M3:${name},${b},${e},${m},${t1},${t2},${diff},${fav}`;
    
    if (typeof QRCode === "undefined") return alert("ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒæº–å‚™ä¸­ã§ã™");

    try {
        new QRCode(out, {
            text: data,
            width: 160,
            height: 160,
            colorDark : "#000000",
            colorLight : "#ffffff",
            correctLevel: QRCode.CorrectLevel.H
        });
        console.log("QRç”Ÿæˆå®Œäº†:", data);
    } catch (err) {
        alert("QRç”Ÿæˆã‚¨ãƒ©ãƒ¼: å†…å®¹ã‚’çŸ­ãã—ã¦ãã ã•ã„ã€‚");
    }
}

function scanFile(input) {
    if (!input.files || !input.files[0]) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
            const cvs = document.createElement('canvas');
            const ctx = cvs.getContext('2d');
            cvs.width = img.width; 
            cvs.height = img.height;
            ctx.drawImage(img, 0, 0);
            
            const imageData = ctx.getImageData(0, 0, cvs.width, cvs.height);
            const qr = jsQR(imageData.data, cvs.width, cvs.height, {
                inversionAttempts: "attemptBoth"
            });

            if(qr) {
                const qrContent = qr.data.trim();
                if(qrContent.indexOf("M3:") === 0) {
                    const rawStr = qrContent.substring(3);
                    const parts = rawStr.split(",");
                    
                    if(parts.length >= 4) {
                        const petData = {
                            name: parts[0],
                            bodyId: parts[1],
                            eyeId: parts[2],
                            mouthId: parts[3],
                            t1: parts[4] || "",
                            t2: parts[5] || "",
                            diff: parseInt(parts[6]) || 1
                        };

                        const price = petData.diff * 200;
                        
                        // --- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºã®ä½œæˆ ---
                        const preview = document.getElementById('buy-preview');
                        const body = MASTER_DATA.bodies.find(b => b.id === petData.bodyId);
                        const eye = MASTER_DATA.eyes.find(e => e.id === petData.eyeId);
                        const mouth = MASTER_DATA.mouths.find(m => m.id === petData.mouthId);

                        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼HTMLã‚’çµ„ã¿ç«‹ã¦
                        preview.innerHTML = `
                            <img src="${body ? body.img : ''}" style="position:absolute; width:100%; top:0; left:0;">
                            <img src="${eye ? eye.img : ''}" style="position:absolute; width:100%; top:0; left:0;">
                            <img src="${mouth ? mouth.img : ''}" style="position:absolute; width:100%; top:0; left:0;">
                        `;

                        // è©³ç´°æƒ…å ±ã®è¡¨ç¤º
                        document.getElementById('buy-area').style.display = 'block';
                        document.getElementById('buy-info').innerHTML = `
                            <div style="font-size:1.1em; color:#ff4785;">${petData.name}</div>
                            <div style="font-size:0.8em; color:#888; margin-bottom:5px;">
                                #${petData.t1} #${petData.t2}
                            </div>
                            <div>ä¾¡æ ¼: ğŸ’°${price} ã‚³ã‚¤ãƒ³</div>
                        `;
                        
                        // è³¼å…¥ãƒœã‚¿ãƒ³ã®å‡¦ç†
                        document.getElementById('buy-btn').onclick = () => {
                            if(userData.money < price) return alert("ã‚³ã‚¤ãƒ³ãŒè¶³ã‚Šã¾ã›ã‚“ï¼");
                            
                            userData.money -= price;
                            const newPet = { 
                                id: Date.now(), 
                                name: petData.name, 
                                bodyId: petData.bodyId, 
                                eyeId: petData.eyeId, 
                                mouthId: petData.mouthId, 
                                tags: [petData.t1, petData.t2], 
                                hunger: 100, 
                                feeling: 0, 
                                equippedAcc: [] 
                            };

                            userData.boxPets.push(newPet);
                            save();
                            saveToLocalStorage();
                            alert(`${petData.name} ã‚’è¿ãˆã¾ã—ãŸï¼ãƒœãƒƒã‚¯ã‚¹ã‚’ç¢ºèªã—ã¦ã­ã€‚`);
                            document.getElementById('buy-area').style.display = 'none';
                            closeAllModals();
                            refreshRoom();
                        };
                    }
                } else {
                    alert("ã“ã‚Œã¯ã¾ã‚‹ã¡ã‚ƒã‚“ã®QRã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");
                }
            } else {
                alert("QRã‚³ãƒ¼ãƒ‰ãŒèªè­˜ã§ãã¾ã›ã‚“ã€‚");
            }
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(input.files[0]);
}

/** --- ã‚­ãƒ¢ãƒã‚’ãŠé‡‘ã«æ›ãˆã‚‹ (é€ä¿¡) --- **/
function sendFeeling() {
    // è©³ç´°ç”»é¢ã§é¸æŠä¸­ã®ãƒšãƒƒãƒˆã‚’å–å¾—
    const p = userData.roomPets.find(x => x.id === selectedPetId);
    if (!p) return;

    if (!p.feeling || p.feeling <= 0) {
        alert("ã¾ã ã‚­ãƒ¢ãƒãŒè²¯ã¾ã£ã¦ã„ã¾ã›ã‚“ã€‚");
        return;
    }

    const earnedMoney = Math.floor(p.feeling);
    
    // 1. æ‰€æŒé‡‘ã‚’åŠ ç®—
    userData.money += earnedMoney;
    
    // 2. ãƒšãƒƒãƒˆã®ã‚­ãƒ¢ãƒã‚’ãƒªã‚»ãƒƒãƒˆ
    p.feeling = 0;

    // 3. é‡è¦ï¼šã“ã®ç¬é–“ã« localStorage ã¸å¼·åˆ¶ä¿å­˜
    // 5ç§’ã”ã¨ã®è‡ªå‹•ä¿å­˜ã‚’å¾…ãŸãšã«ã€å³åº§ã«æ›¸ãè¾¼ã¿ã¾ã™
    userData.lastSaveTime = Date.now(); // ä¿å­˜æ™‚åˆ»ã‚‚æ›´æ–°
    localStorage.setItem('maru_v3_ext', JSON.stringify(userData));
    
    alert(`ğŸ’° ${earnedMoney}ã‚³ã‚¤ãƒ³ ç²å¾—ï¼\nç¾åœ¨ã®æ‰€æŒé‡‘: ${userData.money}ã‚³ã‚¤ãƒ³`);
    
    // 4. UIã®æ›´æ–°
    refreshRoom(); // æ‰€æŒé‡‘è¡¨ç¤ºã‚’æ›´æ–°
    openDetail(p); // è©³ç´°ç”»é¢ã®æ•°å€¤ã‚’ãƒªã‚»ãƒƒãƒˆ
}

// localStorageã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€é–¢æ•°
function load() {
    const d = localStorage.getItem('maru_v3_ext');
    if (d) {
        userData = JSON.parse(d);
        
        // ãƒ‡ãƒ¼ã‚¿ã®æ¬ æã‚’è£œå®Œï¼ˆç‰¹ã« feeling ãŒ undefined ã®å ´åˆï¼‰
        const allPets = [...userData.roomPets, ...userData.boxPets];
        allPets.forEach(p => {
// ã“ã“ãŒé‡è¦ï¼ã‚¢ã‚¯ã‚»ã‚µãƒªã®ãƒ‡ãƒ¼ã‚¿ãŒãªã‘ã‚Œã°ç©ºã®é…åˆ—ã‚’ä½œã‚‹
            if (!p.equippedAcc || !Array.isArray(p.equippedAcc)) {
                p.equippedAcc = [];
            }
            if (p.feeling === undefined) p.feeling = 0;
            if (p.hunger === undefined) p.hunger = 100;
        });

        // éƒ¨å±‹ã®è‰²ã‚’é©ç”¨
        document.documentElement.style.setProperty('--wall-color', userData.roomConfig.wall);
        document.documentElement.style.setProperty('--floor-color', userData.roomConfig.floor);
    }
}

function calculateProgress(totalMinutes) {
    const allPets = [...userData.roomPets, ...userData.boxPets];
    
    allPets.forEach(p => {
        // 1. æº€è…¹åº¦ã®æ¸›å°‘ (10åˆ†ã§ 1 æ¸›ã‚‹ = 1åˆ†ã§ 0.1 æ¸›ã‚‹)
        const oldHunger = p.hunger || 0;
        const hungerLoss = totalMinutes * 0.1; 
        p.hunger = Math.max(0, oldHunger - hungerLoss);

        // 2. ã‚­ãƒ¢ãƒã®ä¸Šæ˜‡ (æº€è…¹åº¦ãŒ 0 ã§ãªã‘ã‚Œã° 1åˆ†ã§ 2 å¢—ãˆã‚‹)
        // æ”¾ç½®ä¸­ã«æº€è…¹åº¦ãŒ 0 ã«ãªã‚‹ã¾ã§ã®æ™‚é–“ã‚’è€ƒæ…®ã—ã¦è¨ˆç®—
        let happyMinutes = 0;
        if (oldHunger > 0) {
            // æº€è…¹åº¦ãŒ0ã«ãªã‚‹ã¾ã§ã®æ™‚é–“(åˆ†) = ç¾åœ¨ã®æº€è…¹åº¦ / 0.1
            const minutesToStarve = oldHunger / 0.1;
            happyMinutes = Math.min(totalMinutes, minutesToStarve);
        }

        p.feeling = (p.feeling || 0) + Math.floor(happyMinutes * 2);
    });
}

/** --- åå‰ã®å¤‰æ›´ã¨ä¿å­˜ --- **/
function updatePetName(petId, newName) {
    if (!newName.trim()) return; // ç©ºæ–‡å­—ãªã‚‰ç„¡è¦–

    // éƒ¨å±‹ã¨ãƒœãƒƒã‚¯ã‚¹ä¸¡æ–¹ã‹ã‚‰å¯¾è±¡ã®ãƒšãƒƒãƒˆã‚’æ¢ã™
    let target = userData.roomPets.find(p => p.id === petId);
    if (!target) {
        target = userData.boxPets.find(p => p.id === petId);
    }

    if (target) {
        target.name = newName;
        save(); // LocalStorageã«å³æ™‚ä¿å­˜
        saveToLocalStorage();
        console.log(`åå‰ã‚’ ${newName} ã«å¤‰æ›´ã—ã¾ã—ãŸ`);
        
        // éƒ¨å±‹ã«ã„ã‚‹ãƒšãƒƒãƒˆãªã‚‰ã€åå‰ã®è¡¨ç¤ºï¼ˆã‚‚ã—ã‚ã‚Œã°ï¼‰ã‚’æ›´æ–°ã™ã‚‹ãŸã‚ã«å†æç”»
        refreshRoom(); 
    }
}
window.onload = () => { 
    load(); 
    applyOfflineTime(); // èµ·å‹•æ™‚ã«æ”¾ç½®ã—ã¦ã„ãŸåˆ†ã‚’è¨ˆç®—
    checkLoginBonus();
    refreshRoom(); 
    
    // 5ç§’ã”ã¨ã«è‡ªå‹•ã‚»ãƒ¼ãƒ–ï¼ˆãã®éš›ã«ãŠè…¹/ã‚­ãƒ¢ãƒã‚‚1åˆ†å˜ä½ã§è¨ˆç®—ã•ã‚Œã‚‹ï¼‰
    setInterval(save, 5000); 

    // è©³ç´°ç”»é¢ã®æ•°å€¤ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«ï¼ˆ1ç§’ã”ã¨ã«ï¼‰æ›¸ãæ›ãˆã‚‹
    setInterval(() => {
        if(document.getElementById('detail-modal').classList.contains('modal-open')) {
            const p = userData.roomPets.find(x => x.id === selectedPetId);
            if(p) {
                // è¡¨ç¤ºç”¨ï¼šæº€è…¹åº¦ã¯å°æ•°ç‚¹ç¬¬1ä½ã¾ã§ã€ã‚­ãƒ¢ãƒã¯æ•´æ•°
                document.getElementById('det-hunger').innerText = (p.hunger || 0).toFixed(1);
                document.getElementById('det-feeling').innerText = Math.floor(p.feeling || 0);
            }
        }
    }, 1000);
};

/** --- ãƒ‡ãƒ¼ã‚¿ã®å¼·åˆ¶ä¿å­˜ (GitHub/ãƒªãƒ­ãƒ¼ãƒ‰å¯¾ç­–) --- **/
function saveToLocalStorage() {
    // ä¿å­˜ç›´å‰ã«æ™‚åˆ»ã‚’æ›´æ–°ï¼ˆæ”¾ç½®æ™‚é–“ã®è¨ˆç®—ãŒã‚ºãƒ¬ãªã„ã‚ˆã†ã«ï¼‰
    userData.lastSaveTime = Date.now();
    
    // æ–‡å­—åˆ—ã«ã—ã¦ä¿å­˜
    const json = JSON.stringify(userData);
    localStorage.setItem('maru_v3_ext', json);
    
    // ç”»é¢ã®æ‰€æŒé‡‘è¡¨ç¤ºã‚’æ›´æ–°
    const moneyDisp = document.getElementById('money-display');
    if (moneyDisp) moneyDisp.innerText = userData.money;
    
    console.log("ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ:", userData);
}
</script>
</body>
</html>